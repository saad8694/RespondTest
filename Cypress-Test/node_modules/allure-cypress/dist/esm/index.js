var u=function(e){return e.FAILED="failed",e.BROKEN="broken",e.PASSED="passed",e.SKIPPED="skipped",e}({}),Ue=[u.FAILED,u.BROKEN,u.PASSED,u.SKIPPED],je=function(e){return e.SCHEDULED="scheduled",e.RUNNING="running",e.FINISHED="finished",e.PENDING="pending",e.INTERRUPTED="interrupted",e}({}),l=function(e){return e.ALLURE_ID="ALLURE_ID",e.AS_ID="ALLURE_ID",e.SUITE="suite",e.PARENT_SUITE="parentSuite",e.SUB_SUITE="subSuite",e.EPIC="epic",e.FEATURE="feature",e.STORY="story",e.SEVERITY="severity",e.TAG="tag",e.OWNER="owner",e.LEAD="lead",e.HOST="host",e.THREAD="thread",e.TEST_METHOD="testMethod",e.TEST_CLASS="testClass",e.PACKAGE="package",e.FRAMEWORK="framework",e.LANGUAGE="language",e.LAYER="layer",e}({}),Ge=function(e){return e.BLOCKER="blocker",e.CRITICAL="critical",e.NORMAL="normal",e.MINOR="minor",e.TRIVIAL="trivial",e}({}),w=function(e){return e.TEXT="text/plain",e.XML="application/xml",e.HTML="text/html",e.CSV="text/csv",e.TSV="text/tab-separated-values",e.CSS="text/css",e.URI="text/uri-list",e.SVG="image/svg+xml",e.PNG="image/png",e.JSON="application/json",e.ZIP="application/zip",e.WEBM="video/webm",e.JPEG="image/jpeg",e.MP4="video/mp4",e.IMAGEDIFF="application/vnd.allure.image.diff",e}({}),R=function(e){return e.DEFAULT="link",e.ISSUE="issue",e.TMS="tms",e}({});function P(){P=function(a,o){return new r(a,void 0,o)};var e=RegExp.prototype,t=new WeakMap;function r(n,a,o){var i=RegExp(n,a);return t.set(i,o||t.get(n)),k(i,r.prototype)}function s(n,a){var o=t.get(a);return Object.keys(o).reduce(function(i,p){var g=o[p];if(typeof g=="number")i[p]=n[g];else{for(var S=0;n[g[S]]===void 0&&S+1<g.length;)S++;i[p]=n[g[S]]}return i},Object.create(null))}return Be(r,RegExp),r.prototype.exec=function(n){var a=e.exec.call(this,n);if(a){a.groups=s(a,this);var o=a.indices;o&&(o.groups=s(o,this))}return a},r.prototype[Symbol.replace]=function(n,a){if(typeof a=="string"){var o=t.get(this);return e[Symbol.replace].call(this,n,a.replace(/\$<([^>]+)>/g,function(p,g){var S=o[g];return"$"+(Array.isArray(S)?S.join("$"):S)}))}if(typeof a=="function"){var i=this;return e[Symbol.replace].call(this,n,function(){var p=arguments;return typeof p[p.length-1]!="object"&&(p=[].slice.call(p)).push(s(p,i)),a.apply(this,p)})}return e[Symbol.replace].call(this,n,a)},P.apply(this,arguments)}function Be(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&k(e,t)}function k(e,t){return k=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,s){return r.__proto__=s,r},k(e,t)}var T=e=>{switch(!0){case/assert/gi.test(e.constructor.name):case/expectation/gi.test(e.constructor.name):case/assert/gi.test(e.name):case/assert/gi.test(e.message):case(e.stack&&/@vitest\/expect/gi.test(e.stack)):return u.FAILED;default:return u.BROKEN}},Ve=function(){var{onlyFirst:t=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},r=["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))"].join("|");return new RegExp(r,t?void 0:"g")},I=e=>{var t=Ve();return e.replace(t,"")},f=e=>{var{message:t,stack:r}=e;return{message:t?I(t):void 0,trace:r?I(r):void 0}},te=P(/(?:^|\s)@?allure\.id[:=]([^\s]+)/,{id:1}),Ke=new RegExp(te,"g"),re=P(/(?:^|\s)@?allure\.label\.([^:=\s]+)[:=]([^\s]+)/,{name:1,value:2}),ze=new RegExp(re,"g");var F=e=>{var t=[];e.split(" ").forEach(s=>{var n,a=(n=s.match(te))===null||n===void 0||(n=n.groups)===null||n===void 0?void 0:n.id;a&&t.push({name:l.ALLURE_ID,value:a});var o=s.match(re),{name:i,value:p}=o?.groups||{};i&&p&&t?.push({name:i,value:p})});var r=e.replace(ze,"").replace(Ke,"").trim();return{labels:t,cleanTitle:r}};var We=e=>e.reduce((t,r)=>{if(r.type!=="step_start"&&r.type!=="step_stop")return t;if(r.type==="step_start")return t.push([r]),t;var s=t.findLastIndex(n=>n.length===1);return s===-1||t[s].push(r),t},[]),O=e=>{var t=We(e);return t.filter(r=>r.length===1)},x=e=>!!e&&(typeof e=="object"||typeof e=="function")&&typeof e.then=="function",H=function(t){var{maxDepth:r=0,maxLength:s=0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return Ze(typeof t=="object"?JSON.stringify(t,$e(r)):String(t),s)},$e=e=>{var t=[];return function(r,s){if(typeof s!="object"||s===null)return s;for(;t.length>0&&!Object.is(t.at(-1),this);)t.pop();if(!(e&&t.length>=e||t.includes(s)))return t.push(s),s instanceof Map?Ye(t,s):s instanceof Set?qe(t,s):s}},Ye=(e,t)=>Array.from(t).filter(r=>{var[s]=r;return!e.includes(s)}).map(r=>{var[s,n]=r;return[s,e.includes(n)?void 0:n]}),qe=(e,t)=>Array.from(t).map(r=>e.includes(r)?void 0:r),Ze=(e,t)=>t&&e.length>t?"".concat(e.substring(0,t),"..."):e;var E="__allure_report_system_hook__",_="__allure_report_step_command__";function se(e,t,r,s,n,a,o){try{var i=e[a](o),p=i.value}catch(g){return void r(g)}i.done?t(p):Promise.resolve(p).then(s,n)}function m(e){return function(){var t=this,r=arguments;return new Promise(function(s,n){var a=e.apply(t,r);function o(p){se(a,s,n,o,i,"next",p)}function i(p){se(a,s,n,o,i,"throw",p)}o(void 0)})}}var N=class{attachment(){var t=this;return m(function*(){yield t.warning()})()}attachmentFromPath(){var t=this;return m(function*(){yield t.warning()})()}description(){var t=this;return m(function*(){yield t.warning()})()}descriptionHtml(){var t=this;return m(function*(){yield t.warning()})()}displayName(){var t=this;return m(function*(){yield t.warning()})()}historyId(){var t=this;return m(function*(){yield t.warning()})()}labels(){var t=this;return m(function*(){yield t.warning()})()}links(){var t=this;return m(function*(){yield t.warning()})()}parameter(){var t=this;return m(function*(){yield t.warning()})()}logStep(){var t=this;return m(function*(){yield t.warning()})()}step(t,r){var s=this;return m(function*(){return yield s.warning(),r()})()}stepDisplayName(){var t=this;return m(function*(){yield t.warning()})()}stepParameter(){var t=this;return m(function*(){yield t.warning()})()}testCaseId(){var t=this;return m(function*(){yield t.warning()})()}warning(){return m(function*(){console.log("no test runtime is found. Please check test framework configuration")})()}},v=new N;var ne="allureTestRuntime",U=e=>{globalThis[ne]=()=>e},L=()=>globalThis?.[ne],j=()=>{var e=L();if(e){var t;return(t=e())!==null&&t!==void 0?t:v}return v},G=()=>{var e=L();if(e){var t;return(t=e())!==null&&t!==void 0?t:v}if("_playwrightInstance"in globalThis)try{return(0,eval)("(() => import('allure-playwright/autoconfig'))()").then(()=>{var r,s;return(r=(s=L())===null||s===void 0?void 0:s())!==null&&r!==void 0?r:v})}catch(r){return console.log("can't execute allure-playwright/autoconfig",r),v}return v};var d=function(t){for(var r=arguments.length,s=new Array(r>1?r-1:0),n=1;n<r;n++)s[n-1]=arguments[n];var a=G();return x(a)?a.then(o=>o[t](...s)):a[t](...s)},y=(e,t)=>d("labels",{name:e,value:t}),Je=function(){for(var t=arguments.length,r=new Array(t),s=0;s<t;s++)r[s]=arguments[s];return d("labels",...r)},B=(e,t,r)=>d("links",{url:e,type:r,name:t}),Xe=function(){for(var t=arguments.length,r=new Array(t),s=0;s<t;s++)r[s]=arguments[s];return d("links",...r)},Qe=(e,t,r)=>d("parameter",e,t,r),et=e=>d("description",e),tt=e=>d("descriptionHtml",e),rt=e=>d("displayName",e),st=e=>d("historyId",e),nt=e=>d("testCaseId",e),at=(e,t,r)=>{var s=typeof r=="string"?{contentType:r}:r;return d("attachment",e,t,s)},ot=(e,t,r)=>{var s=typeof r=="string"?{contentType:r}:r;return d("attachmentFromPath",e,t,s)},it=()=>({displayName:e=>d("stepDisplayName",e),parameter:(e,t,r)=>d("stepParameter",e,t,r)}),pt=(e,t,r)=>d("logStep",e,t,r),ut=(e,t)=>d("step",e,()=>t(it())),lt=(e,t)=>B(e,t,R.ISSUE),ct=(e,t)=>B(e,t,R.TMS),dt=e=>y(l.ALLURE_ID,e),mt=e=>y(l.EPIC,e),yt=e=>y(l.FEATURE,e),gt=e=>y(l.STORY,e),ft=e=>y(l.SUITE,e),ht=e=>y(l.PARENT_SUITE,e),St=e=>y(l.SUB_SUITE,e),Tt=e=>y(l.OWNER,e),vt=e=>y(l.SEVERITY,e),Ct=e=>y(l.LAYER,e),xt=e=>y(l.TAG,e),Et=function(){for(var t=arguments.length,r=new Array(t),s=0;s<t;s++)r[s]=arguments[s];return d("labels",...r.map(n=>({name:l.TAG,value:n})))};var ae={stepsFromCommands:{maxArgumentLength:128,maxArgumentDepth:3}},oe=e=>Array.isArray(e)||e.buffer?btoa(String.fromCharCode.apply(null,e)):e,ie=e=>{let t=[];for(let r=e.parent;r;r=r.parent)t.push(r);return t.reverse(),t};var V=e=>At(e.attributes.args)?.log===!1||e.attributes.name==="task"&&e.attributes.args[0]==="reportAllureRuntimeMessages"||e.attributes.name==="then"||e.attributes.name==="wrap"&&e.attributes.args[0]===_;var At=e=>e[e.length-1],pe=(e,t)=>{let r=t.title,{cleanTitle:s,labels:n}=F(r),a=t.titlePath().slice(0,-1),o=`${e.relative}#${[...a,s].join(" ")}`;return{name:s,labels:n,fullName:o}},K=e=>({...pe(Cypress.spec,e),start:e.wallClockStartedAt?.getTime()||Date.now()}),ue=e=>({duration:e.duration??0,retries:e._retries??0}),z=()=>({statusDetails:{message:"This is a pending test"}}),le=(e,t)=>{let r=ge();if(r)for(let s of de(t)){let n=bt(r,e,s.tests);Rt(s.tests,n)}};var ce=Symbol("The test was reported to Allure"),W=e=>{e[ce]=!0},A=e=>e[ce]===!0,de=function*(e){let t=[];for(let r=e;r;r=t.pop()){yield r;for(let s=r.suites.length-1;s>=0;s--)t.push(r.suites[s])}},me=function*(e){for(let t of de(e))yield*t.tests},C=e=>e.title.includes(E),ye=e=>e.parent.root&&e.hookName==="after all",Mt=(e,t,r)=>e.tests.some(s=>r&&s.id?.toString()===r||s.selector===t),bt=(e,t,r)=>{let s=[];return r.forEach((n,a)=>{let{fullName:o,labels:i}=pe(t,n),p=i.find(({name:g})=>g===l.ALLURE_ID)?.value;Mt(e,o,p)||s.push(a)}),s},Rt=(e,t)=>{for(let r=t.length-1;r>=0;r--)e.splice(t[r],1)};var h=()=>{let e=Cypress.env("allure");return e||(e={config:ae,initialized:!1,messages:[],testPlan:void 0,currentTest:void 0},Cypress.env("allure",e)),e},fe=()=>h().initialized,he=()=>{h().initialized=!0},M=()=>h().messages,Se=e=>{h().messages=e},c=e=>{M().push(e)},ge=()=>h().testPlan,Te=()=>h().currentTest,ve=e=>{h().currentTest=e},Ce=()=>{h().currentTest=void 0},xe=()=>h().config;var $=class{constructor(){this.#t()}labels(...t){return this.#e({type:"metadata",data:{labels:t}})}links(...t){return this.#e({type:"metadata",data:{links:t}})}parameter(t,r,s){return this.#e({type:"metadata",data:{parameters:[{name:t,value:r,...s}]}})}description(t){return this.#e({type:"metadata",data:{description:t}})}descriptionHtml(t){return this.#e({type:"metadata",data:{descriptionHtml:t}})}displayName(t){return this.#e({type:"metadata",data:{displayName:t}})}historyId(t){return this.#e({type:"metadata",data:{historyId:t}})}testCaseId(t){return this.#e({type:"metadata",data:{testCaseId:t}})}attachment(t,r,s){let n=r?.type==="Buffer"?r.data:r,a=typeof n=="string"?"utf8":"base64",o=oe(n);return this.#e({type:"attachment_content",data:{name:t,content:o,encoding:a,contentType:s.contentType,fileExtension:s.fileExtension}})}attachmentFromPath(t,r,s){return this.#e({type:"attachment_path",data:{name:t,path:r,contentType:s.contentType,fileExtension:s.fileExtension}})}logStep(t,r=u.PASSED,s){return cy.wrap(_,{log:!1}).then(()=>(this.#e({type:"step_start",data:{name:t,start:Date.now()}}),Cypress.Promise.resolve())).then(()=>this.#e({type:"step_stop",data:{status:r,stop:Date.now(),statusDetails:s?{...f(s)}:void 0}}))}step(t,r){return cy.wrap(_,{log:!1}).then(()=>(this.#e({type:"step_start",data:{name:t,start:Date.now()}}),Cypress.Promise.resolve(r()))).then(s=>this.#e({type:"step_stop",data:{status:u.PASSED,stop:Date.now()}}).then(()=>s))}stepDisplayName(t){return this.#e({type:"step_metadata",data:{name:t}})}stepParameter(t,r,s){return this.#e({type:"step_metadata",data:{parameters:[{name:t,value:r,mode:s}]}})}flushAllureMessagesToTask=t=>{let r=this.#r();r.length&&cy.task(t,{absolutePath:Cypress.spec.absolute,messages:r},{log:!1})};flushAllureMessagesToTaskAsync=t=>{let r=this.#r();if(r.length){let s={absolutePath:Cypress.spec.absolute,messages:r,isInteractive:Cypress.config("isInteractive")};return cy.task(t,s,{log:!1})}};#t=()=>Se([]);#e=t=>(c(t),Cypress.Promise.resolve());#r=()=>{let t=M();return this.#t(),t}},Ae=()=>U(new $),Me=()=>j(),be=()=>{c({type:"cypress_run_start",data:{}})},Re=e=>{c({type:"cypress_suite_start",data:{id:e.id,name:e.title,root:e.root,start:Date.now()}})},Pe=e=>{c({type:"cypress_suite_end",data:{root:e.root,stop:Date.now()}})},Y=(e,t)=>{c({type:"cypress_hook_start",data:{name:e.title,scopeType:e.hookName.includes("each")?"each":"all",position:e.hookName.includes("before")?"before":"after",start:t??Date.now()}})},D=e=>{c({type:"cypress_hook_end",data:{duration:e.duration??0}})},q=e=>{ve(e),c({type:"cypress_test_start",data:K(e)}),W(e)},Z=(e,t)=>{let r=M();O(r).forEach(()=>{c({type:"step_stop",data:{stop:Date.now(),status:e,statusDetails:t}})})},ke=()=>{Z(u.PASSED),c({type:"cypress_test_pass",data:{}})},De=e=>{A(e)?Oe(u.SKIPPED,{message:"The test was skipped before the command was completed"}):q(e),c({type:"cypress_test_skip",data:z()})},we=e=>{let{stepsFromCommands:{maxArgumentDepth:t,maxArgumentLength:r}}=xe();c({type:"cypress_command_start",data:{name:`Command "${e.attributes.name}"`,args:e.attributes.args.map(s=>H(s,{maxDepth:t,maxLength:r})),start:Date.now()}})},Ie=()=>{c({type:"cypress_command_end",data:{status:u.PASSED,stop:Date.now()}})},Fe=(e,t)=>{c({type:"attachment_path",data:{path:e,name:t||"Screenshot",contentType:w.PNG}})},Oe=(e,t)=>{let r=M(),s=r.toReversed().findIndex(({type:i})=>i==="cypress_command_start"),n=r.toReversed().findIndex(({type:i})=>i==="cypress_command_end"),a=s>n,o={status:e,stop:Date.now()};t&&(o.statusDetails=t),a&&c({type:"cypress_command_end",data:o})},J=e=>{let t=T(e),r=f(e);Oe(t,r),c({type:"cypress_fail",data:{status:t,statusDetails:r}})},X=e=>{c({type:"cypress_test_end",data:{duration:e.duration??0,retries:e._retries??0}}),Ce()},Q=(e,t)=>{let r=e.hookName.includes("each"),s=e.parent,n=wt(e.title,r,t,s);D(e),Pt(),kt(s,n)},He=()=>{let[e,t,r]=Ht();Ot(t,r),Nt(e)},ee=()=>Me().flushAllureMessagesToTask("reportAllureCypressSpecMessages"),Ne=()=>Me().flushAllureMessagesToTaskAsync("reportFinalAllureCypressSpecMessages"),b=e=>{if(Gt(e)){let t=e.test;return C(t)||D(t),Ne()}},Le=(e,t)=>{try{return J(t),Q(e.test,t),Ne()}catch(r){jt(e,r)}},Pt=()=>{let e=Te();e&&X(e)},kt=(e,t)=>{for(let r of me(e))A(r)||Dt(r,r.pending?{...z(),status:u.SKIPPED}:t)},Dt=(e,t)=>{c({type:"cypress_skipped_test",data:{...K(e),...t,...ue(e),suites:ie(e).map(r=>r.id)}}),W(e)},wt=(e,t,r,s)=>{let n=t?u.SKIPPED:T(r),{message:a,trace:o}=f(r);return{status:n,statusDetails:{message:t?It(e,s):a,trace:o}}},It=(e,t)=>{let r=t.title?`'${t.title}'`:"root";return`'${e}' defined in the ${r} suite has failed`},Ft=(e,...t)=>{let[r,s,n]=t;return typeof n>"u"&&typeof s>"u"?e(r):typeof s=="function"?e(r,s):e(r,s,n)},Ot=(e,t)=>{let r=a=>(o,i,p)=>{e();try{return Ft(a,o,i,p)}finally{t()}},s=globalThis.describe,n=r(s);n.only=r(s.only),n.skip=r(s.skip),globalThis.describe=n},Ht=()=>{let e=0;return[()=>e,()=>{e++},()=>{e--}]},Nt=e=>{let t=globalThis.after,r=(s,n)=>typeof s=="string"?t(s,Ee(e,n)):t(Ee(e,s));globalThis.after=r},Ee=(e,t)=>{if(e()===0&&t){let r=t.length?Lt(t):Ut(t);return Object.defineProperty(r,"name",{value:t.name}),r}return t},Lt=e=>function(t){let r=s=>{if(s){Le(this,s)?.then(()=>t(s))||t(s);return}try{if(b(this)?.then(()=>t()))return}catch(n){t(n);return}t()};return e.bind(this)(r)},Ut=e=>function(){let t,r;try{t=e.bind(this)()}catch(s){r=s}if(r)_e(this,r);else return x(t)?t.then(()=>b(this),s=>_e(this,s)):(b(this),t)},_e=(e,t)=>{if(!Le(e,t)?.then(()=>{throw t}))throw t},jt=(e,t)=>{try{console.error(`Unexpected error when reporting the failure of ${e.test?.title??"'after all'"}`),console.error(t)}catch{}},Gt=e=>{let t=e.test;return e.test.parent.hooks.findLast(a=>a.hookName==="after all")?.hookId===t.hookId};var{EVENT_RUN_BEGIN:Bt,EVENT_SUITE_BEGIN:Vt,EVENT_SUITE_END:Kt,EVENT_HOOK_BEGIN:zt,EVENT_HOOK_END:Wt,EVENT_TEST_BEGIN:$t,EVENT_TEST_PASS:Yt,EVENT_TEST_FAIL:qt,EVENT_TEST_PENDING:Zt,EVENT_TEST_END:Jt}=Mocha.Runner.constants,Xt=()=>{fe()||(he(),Cypress.mocha.getRunner().on(Bt,()=>{Ae(),be()}).on(Vt,e=>{e.root&&le(Cypress.spec,e),Re(e)}).on(Kt,e=>{Pe(e)}).on(zt,e=>{C(e)||Y(e)}).on(Wt,e=>{C(e)||D(e)}).on($t,e=>{A(e)||q(e)}).on(Yt,()=>{ke()}).on(qt,(e,t)=>{let r="hookName"in e;if(r&&ye(e))return;r&&C(e)&&Y(e,Date.now()-(e.duration??0)),J(t),r&&Q(e,t)}).on(Zt,e=>{De(e)}).on(Jt,e=>{X(e)}),Cypress.Screenshot.defaults({onAfterScreenshot:(e,{path:t,name:r})=>{Fe(t,r)}}),Cypress.on("fail",e=>{let t=T(e),r=f(e);throw Z(t,r),e}),Cypress.on("command:start",e=>{V(e)||we(e)}),Cypress.on("command:end",e=>{V(e)||Ie()}),afterEach(E,ee),after(E,function(){ee(),b(this)}),He())};Xt();export{w as ContentType,l as LabelName,R as LinkType,Ge as Severity,je as Stage,u as Status,Ue as StatusByPriority,dt as allureId,at as attachment,ot as attachmentPath,et as description,tt as descriptionHtml,rt as displayName,mt as epic,yt as feature,st as historyId,lt as issue,y as label,Je as labels,Ct as layer,B as link,Xe as links,pt as logStep,Tt as owner,Qe as parameter,ht as parentSuite,vt as severity,ut as step,gt as story,St as subSuite,ft as suite,xt as tag,Et as tags,nt as testCaseId,ct as tms};
//# sourceMappingURL=index.js.map
